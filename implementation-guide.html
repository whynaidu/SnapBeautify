<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnapBeautify - Paid Tier Implementation Guide</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #8b5cf6;
            --primary-dark: #7c3aed;
            --secondary: #ec4899;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #0ea5e9;
            --dark: #0f172a;
            --dark-light: #1e293b;
            --dark-lighter: #334155;
            --gray: #64748b;
            --light: #f1f5f9;
            --white: #ffffff;
            --gradient: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            --code-bg: #0d1117;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--dark);
            color: var(--white);
            line-height: 1.7;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1e40af 0%, #7c3aed 50%, #ec4899 100%);
            padding: 80px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .header-content {
            position: relative;
            z-index: 1;
            max-width: 900px;
            margin: 0 auto;
        }

        .header h1 {
            font-size: 2.75rem;
            font-weight: 800;
            margin-bottom: 16px;
        }

        .header p {
            font-size: 1.25rem;
            opacity: 0.9;
            margin-bottom: 24px;
        }

        .tech-stack {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .tech-badge {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Navigation */
        .nav {
            background: var(--dark-light);
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .nav-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 24px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .nav a {
            color: var(--gray);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
            transition: color 0.2s;
        }

        .nav a:hover {
            color: var(--white);
        }

        /* Container */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Section */
        .section {
            margin-bottom: 60px;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 32px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--primary);
        }

        .section-number {
            width: 48px;
            height: 48px;
            background: var(--gradient);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .section-title {
            font-size: 1.75rem;
            font-weight: 700;
        }

        /* Content */
        h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 32px 0 16px;
            color: var(--primary);
        }

        h4 {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 24px 0 12px;
            color: var(--light);
        }

        p {
            margin-bottom: 16px;
            color: var(--light);
        }

        ul, ol {
            margin-bottom: 16px;
            padding-left: 24px;
        }

        li {
            margin-bottom: 8px;
            color: var(--light);
        }

        strong {
            color: var(--white);
        }

        /* Code Blocks */
        pre {
            background: var(--code-bg);
            border-radius: 12px;
            padding: 20px;
            overflow-x: auto;
            margin: 16px 0 24px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            line-height: 1.6;
        }

        pre code {
            color: #e6edf3;
        }

        p code, li code {
            background: rgba(139, 92, 246, 0.2);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            color: var(--primary);
        }

        /* Syntax Highlighting */
        .keyword { color: #ff7b72; }
        .string { color: #a5d6ff; }
        .comment { color: #8b949e; }
        .function { color: #d2a8ff; }
        .variable { color: #ffa657; }
        .number { color: #79c0ff; }
        .property { color: #7ee787; }

        /* Cards */
        .card {
            background: var(--dark-light);
            border-radius: 16px;
            padding: 24px;
            margin: 16px 0 24px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        /* Alerts */
        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            margin: 16px 0 24px;
            display: flex;
            gap: 12px;
        }

        .alert-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .alert-info {
            background: rgba(14, 165, 233, 0.15);
            border: 1px solid rgba(14, 165, 233, 0.3);
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .alert-success {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .alert-danger {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Steps */
        .step {
            display: flex;
            gap: 16px;
            margin: 24px 0;
            padding: 20px;
            background: var(--dark-light);
            border-radius: 12px;
            border-left: 4px solid var(--primary);
        }

        .step-number {
            width: 32px;
            height: 32px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.875rem;
            flex-shrink: 0;
        }

        .step-content h4 {
            margin: 0 0 8px;
        }

        .step-content p {
            margin: 0;
            color: var(--gray);
            font-size: 0.9375rem;
        }

        /* Tables */
        .table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            margin: 16px 0 24px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--dark-light);
            font-size: 0.9375rem;
        }

        th {
            background: rgba(139, 92, 246, 0.2);
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px 16px;
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        /* File Tree */
        .file-tree {
            background: var(--code-bg);
            border-radius: 12px;
            padding: 20px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            margin: 16px 0 24px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .file-tree .folder {
            color: var(--warning);
        }

        .file-tree .file {
            color: var(--light);
        }

        .file-tree .indent {
            color: var(--dark-lighter);
        }

        /* Architecture Diagram */
        .architecture {
            background: var(--dark-light);
            border-radius: 16px;
            padding: 32px;
            margin: 24px 0;
            text-align: center;
        }

        .arch-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 16px 0;
            flex-wrap: wrap;
        }

        .arch-box {
            background: var(--dark);
            border: 2px solid var(--dark-lighter);
            border-radius: 12px;
            padding: 16px 24px;
            min-width: 140px;
        }

        .arch-box.primary {
            border-color: var(--primary);
            background: rgba(139, 92, 246, 0.1);
        }

        .arch-box.success {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.1);
        }

        .arch-box.info {
            border-color: var(--info);
            background: rgba(14, 165, 233, 0.1);
        }

        .arch-arrow {
            color: var(--gray);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
        }

        /* Checklist */
        .checklist {
            list-style: none;
            padding: 0;
        }

        .checklist li {
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .checklist li::before {
            content: '‚òê';
            color: var(--gray);
            font-size: 1.125rem;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 40px 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            color: var(--gray);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .section-title {
                font-size: 1.5rem;
            }

            pre {
                padding: 16px;
                font-size: 0.8rem;
            }

            .arch-row {
                flex-direction: column;
                align-items: center;
            }

            .arch-arrow {
                transform: rotate(90deg);
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--dark-lighter);
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <h1>üí≥ Paid Tier Implementation Guide</h1>
            <p>Complete step-by-step guide to implement subscription payments for SnapBeautify using Vercel Serverless</p>
            <div class="tech-stack">
                <span class="tech-badge">‚ñ≤ Vercel</span>
                <span class="tech-badge">‚ö° Next.js 14+</span>
                <span class="tech-badge">üí≥ Stripe</span>
                <span class="tech-badge">üîê Supabase Auth</span>
                <span class="tech-badge">üóÑÔ∏è PostgreSQL</span>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-content">
            <a href="#overview">Overview</a>
            <a href="#architecture">Architecture</a>
            <a href="#setup">Project Setup</a>
            <a href="#database">Database</a>
            <a href="#auth">Authentication</a>
            <a href="#stripe">Stripe Setup</a>
            <a href="#api">API Routes</a>
            <a href="#webhooks">Webhooks</a>
            <a href="#frontend">Frontend</a>
            <a href="#feature-gating">Feature Gating</a>
            <a href="#testing">Testing</a>
            <a href="#deployment">Deployment</a>
        </div>
    </nav>

    <div class="container">
        <!-- Section 1: Overview -->
        <section id="overview" class="section">
            <div class="section-header">
                <div class="section-number">1</div>
                <h2 class="section-title">Overview & Tech Stack</h2>
            </div>

            <h3>What We're Building</h3>
            <p>A complete subscription system that allows users to upgrade from Free to Pro tier with:</p>
            <ul>
                <li>User authentication (sign up, login, profile)</li>
                <li>Subscription management (monthly, yearly, lifetime)</li>
                <li>Payment processing via Stripe</li>
                <li>Feature gating based on subscription status</li>
                <li>Customer portal for managing subscriptions</li>
            </ul>

            <h3>Recommended Tech Stack</h3>
            <div class="card-grid">
                <div class="card">
                    <div class="card-title">‚ñ≤ Vercel</div>
                    <p style="margin:0; color: var(--gray); font-size: 0.9rem;">Hosting & Serverless Functions. Edge functions for low latency, automatic scaling.</p>
                </div>
                <div class="card">
                    <div class="card-title">üí≥ Stripe</div>
                    <p style="margin:0; color: var(--gray); font-size: 0.9rem;">Payment processing. Industry standard, excellent docs, handles subscriptions natively.</p>
                </div>
                <div class="card">
                    <div class="card-title">üîê Supabase</div>
                    <p style="margin:0; color: var(--gray); font-size: 0.9rem;">Auth + PostgreSQL database. Free tier generous, real-time subscriptions, Row Level Security.</p>
                </div>
                <div class="card">
                    <div class="card-title">‚ö° Next.js</div>
                    <p style="margin:0; color: var(--gray); font-size: 0.9rem;">Already using it. API routes become serverless functions on Vercel automatically.</p>
                </div>
            </div>

            <div class="alert alert-info">
                <span class="alert-icon">üí°</span>
                <div>
                    <strong>Why Stripe?</strong> Stripe is the industry standard for SaaS payments. It handles PCI compliance, supports 135+ currencies, has excellent documentation, and integrates seamlessly with Vercel. Alternative: Razorpay for India-focused payments.
                </div>
            </div>
        </section>

        <!-- Section 2: Architecture -->
        <section id="architecture" class="section">
            <div class="section-header">
                <div class="section-number">2</div>
                <h2 class="section-title">System Architecture</h2>
            </div>

            <div class="architecture">
                <h4 style="margin-bottom: 24px;">Payment Flow Architecture</h4>
                <div class="arch-row">
                    <div class="arch-box">üë§ User</div>
                    <div class="arch-arrow">‚Üí</div>
                    <div class="arch-box primary">Next.js Frontend</div>
                    <div class="arch-arrow">‚Üí</div>
                    <div class="arch-box info">Vercel API Routes</div>
                </div>
                <div class="arch-row">
                    <div class="arch-box info">Vercel API Routes</div>
                    <div class="arch-arrow">‚Üí</div>
                    <div class="arch-box success">Stripe API</div>
                    <div class="arch-arrow">‚Üí</div>
                    <div class="arch-box">üí≥ Payment</div>
                </div>
                <div class="arch-row">
                    <div class="arch-box success">Stripe Webhooks</div>
                    <div class="arch-arrow">‚Üí</div>
                    <div class="arch-box info">Vercel Webhook Handler</div>
                    <div class="arch-arrow">‚Üí</div>
                    <div class="arch-box primary">Supabase DB</div>
                </div>
            </div>

            <h3>Data Flow Explanation</h3>
            <ol>
                <li><strong>User clicks "Upgrade"</strong> ‚Üí Frontend calls API route</li>
                <li><strong>API creates Stripe Checkout Session</strong> ‚Üí Returns checkout URL</li>
                <li><strong>User redirected to Stripe</strong> ‚Üí Enters payment details</li>
                <li><strong>Payment successful</strong> ‚Üí Stripe sends webhook to your API</li>
                <li><strong>Webhook handler</strong> ‚Üí Updates user subscription in Supabase</li>
                <li><strong>User redirected back</strong> ‚Üí Frontend checks subscription status</li>
                <li><strong>Feature gating</strong> ‚Üí App shows/hides features based on tier</li>
            </ol>

            <h3>File Structure</h3>
            <div class="file-tree">
<span class="folder">üìÅ app/</span>
<span class="indent">‚îú‚îÄ‚îÄ </span><span class="folder">üìÅ api/</span>
<span class="indent">‚îÇ   ‚îú‚îÄ‚îÄ </span><span class="folder">üìÅ auth/</span>
<span class="indent">‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ </span><span class="file">üìÑ [...supabase]/route.ts</span>
<span class="indent">‚îÇ   ‚îú‚îÄ‚îÄ </span><span class="folder">üìÅ stripe/</span>
<span class="indent">‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ </span><span class="file">üìÑ create-checkout/route.ts</span>
<span class="indent">‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ </span><span class="file">üìÑ create-portal/route.ts</span>
<span class="indent">‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ </span><span class="file">üìÑ webhook/route.ts</span>
<span class="indent">‚îÇ   ‚îî‚îÄ‚îÄ </span><span class="folder">üìÅ user/</span>
<span class="indent">‚îÇ       ‚îî‚îÄ‚îÄ </span><span class="file">üìÑ subscription/route.ts</span>
<span class="indent">‚îú‚îÄ‚îÄ </span><span class="folder">üìÅ (auth)/</span>
<span class="indent">‚îÇ   ‚îú‚îÄ‚îÄ </span><span class="file">üìÑ login/page.tsx</span>
<span class="indent">‚îÇ   ‚îî‚îÄ‚îÄ </span><span class="file">üìÑ signup/page.tsx</span>
<span class="indent">‚îú‚îÄ‚îÄ </span><span class="folder">üìÅ pricing/</span>
<span class="indent">‚îÇ   ‚îî‚îÄ‚îÄ </span><span class="file">üìÑ page.tsx</span>
<span class="indent">‚îî‚îÄ‚îÄ </span><span class="file">üìÑ page.tsx</span>
<span class="folder">üìÅ lib/</span>
<span class="indent">‚îú‚îÄ‚îÄ </span><span class="file">üìÑ stripe.ts</span>
<span class="indent">‚îú‚îÄ‚îÄ </span><span class="file">üìÑ supabase-client.ts</span>
<span class="indent">‚îú‚îÄ‚îÄ </span><span class="file">üìÑ supabase-server.ts</span>
<span class="indent">‚îî‚îÄ‚îÄ </span><span class="folder">üìÅ hooks/</span>
<span class="indent">    ‚îî‚îÄ‚îÄ </span><span class="file">üìÑ useSubscription.ts</span>
<span class="folder">üìÅ types/</span>
<span class="indent">‚îî‚îÄ‚îÄ </span><span class="file">üìÑ subscription.ts</span>
            </div>
        </section>

        <!-- Section 3: Project Setup -->
        <section id="setup" class="section">
            <div class="section-header">
                <div class="section-number">3</div>
                <h2 class="section-title">Project Setup</h2>
            </div>

            <h3>Step 1: Install Dependencies</h3>
            <pre><code><span class="comment"># Stripe for payments</span>
npm install stripe @stripe/stripe-js

<span class="comment"># Supabase for auth & database</span>
npm install @supabase/supabase-js @supabase/ssr

<span class="comment"># Utility for webhooks</span>
npm install micro-cors</code></pre>

            <h3>Step 2: Environment Variables</h3>
            <p>Create <code>.env.local</code> in your project root:</p>
            <pre><code><span class="comment"># Supabase</span>
<span class="variable">NEXT_PUBLIC_SUPABASE_URL</span>=<span class="string">your_supabase_project_url</span>
<span class="variable">NEXT_PUBLIC_SUPABASE_ANON_KEY</span>=<span class="string">your_supabase_anon_key</span>
<span class="variable">SUPABASE_SERVICE_ROLE_KEY</span>=<span class="string">your_service_role_key</span>

<span class="comment"># Stripe</span>
<span class="variable">NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY</span>=<span class="string">pk_test_...</span>
<span class="variable">STRIPE_SECRET_KEY</span>=<span class="string">sk_test_...</span>
<span class="variable">STRIPE_WEBHOOK_SECRET</span>=<span class="string">whsec_...</span>

<span class="comment"># Stripe Price IDs (create these in Stripe Dashboard)</span>
<span class="variable">STRIPE_PRICE_MONTHLY</span>=<span class="string">price_...</span>
<span class="variable">STRIPE_PRICE_YEARLY</span>=<span class="string">price_...</span>
<span class="variable">STRIPE_PRICE_LIFETIME</span>=<span class="string">price_...</span>

<span class="comment"># App</span>
<span class="variable">NEXT_PUBLIC_APP_URL</span>=<span class="string">http://localhost:3000</span></code></pre>

            <div class="alert alert-warning">
                <span class="alert-icon">‚ö†Ô∏è</span>
                <div>
                    <strong>Security:</strong> Never commit <code>.env.local</code> to git. Add it to <code>.gitignore</code>. On Vercel, add these as Environment Variables in project settings.
                </div>
            </div>
        </section>

        <!-- Section 4: Database -->
        <section id="database" class="section">
            <div class="section-header">
                <div class="section-number">4</div>
                <h2 class="section-title">Database Setup (Supabase)</h2>
            </div>

            <h3>Step 1: Create Supabase Project</h3>
            <div class="step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <h4>Go to supabase.com</h4>
                    <p>Create a new project. Save the URL and API keys.</p>
                </div>
            </div>

            <h3>Step 2: Create Database Tables</h3>
            <p>Run this SQL in Supabase SQL Editor:</p>
            <pre><code><span class="comment">-- Users table (extends Supabase auth.users)</span>
<span class="keyword">CREATE TABLE</span> <span class="function">public.users</span> (
    <span class="property">id</span> <span class="variable">UUID</span> <span class="keyword">REFERENCES</span> auth.users(<span class="property">id</span>) <span class="keyword">PRIMARY KEY</span>,
    <span class="property">email</span> <span class="variable">TEXT</span>,
    <span class="property">full_name</span> <span class="variable">TEXT</span>,
    <span class="property">avatar_url</span> <span class="variable">TEXT</span>,
    <span class="property">stripe_customer_id</span> <span class="variable">TEXT</span> <span class="keyword">UNIQUE</span>,
    <span class="property">created_at</span> <span class="variable">TIMESTAMPTZ</span> <span class="keyword">DEFAULT</span> <span class="function">NOW</span>(),
    <span class="property">updated_at</span> <span class="variable">TIMESTAMPTZ</span> <span class="keyword">DEFAULT</span> <span class="function">NOW</span>()
);

<span class="comment">-- Subscriptions table</span>
<span class="keyword">CREATE TABLE</span> <span class="function">public.subscriptions</span> (
    <span class="property">id</span> <span class="variable">UUID</span> <span class="keyword">DEFAULT</span> <span class="function">gen_random_uuid</span>() <span class="keyword">PRIMARY KEY</span>,
    <span class="property">user_id</span> <span class="variable">UUID</span> <span class="keyword">REFERENCES</span> public.users(<span class="property">id</span>) <span class="keyword">ON DELETE CASCADE</span>,
    <span class="property">stripe_subscription_id</span> <span class="variable">TEXT</span> <span class="keyword">UNIQUE</span>,
    <span class="property">stripe_price_id</span> <span class="variable">TEXT</span>,
    <span class="property">status</span> <span class="variable">TEXT</span> <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'free'</span>,
    <span class="comment">-- status: 'free', 'active', 'canceled', 'past_due', 'lifetime'</span>
    <span class="property">plan</span> <span class="variable">TEXT</span> <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'free'</span>,
    <span class="comment">-- plan: 'free', 'pro_monthly', 'pro_yearly', 'pro_lifetime'</span>
    <span class="property">current_period_start</span> <span class="variable">TIMESTAMPTZ</span>,
    <span class="property">current_period_end</span> <span class="variable">TIMESTAMPTZ</span>,
    <span class="property">cancel_at_period_end</span> <span class="variable">BOOLEAN</span> <span class="keyword">DEFAULT</span> <span class="keyword">FALSE</span>,
    <span class="property">created_at</span> <span class="variable">TIMESTAMPTZ</span> <span class="keyword">DEFAULT</span> <span class="function">NOW</span>(),
    <span class="property">updated_at</span> <span class="variable">TIMESTAMPTZ</span> <span class="keyword">DEFAULT</span> <span class="function">NOW</span>()
);

<span class="comment">-- Create index for faster lookups</span>
<span class="keyword">CREATE INDEX</span> idx_subscriptions_user_id <span class="keyword">ON</span> public.subscriptions(user_id);
<span class="keyword">CREATE INDEX</span> idx_subscriptions_status <span class="keyword">ON</span> public.subscriptions(status);

<span class="comment">-- Row Level Security (RLS)</span>
<span class="keyword">ALTER TABLE</span> public.users <span class="keyword">ENABLE ROW LEVEL SECURITY</span>;
<span class="keyword">ALTER TABLE</span> public.subscriptions <span class="keyword">ENABLE ROW LEVEL SECURITY</span>;

<span class="comment">-- Users can read their own data</span>
<span class="keyword">CREATE POLICY</span> <span class="string">"Users can view own profile"</span>
    <span class="keyword">ON</span> public.users <span class="keyword">FOR SELECT</span>
    <span class="keyword">USING</span> (auth.uid() = id);

<span class="comment">-- Users can read their own subscription</span>
<span class="keyword">CREATE POLICY</span> <span class="string">"Users can view own subscription"</span>
    <span class="keyword">ON</span> public.subscriptions <span class="keyword">FOR SELECT</span>
    <span class="keyword">USING</span> (auth.uid() = user_id);

<span class="comment">-- Service role can do everything (for webhooks)</span>
<span class="keyword">CREATE POLICY</span> <span class="string">"Service role full access users"</span>
    <span class="keyword">ON</span> public.users <span class="keyword">FOR ALL</span>
    <span class="keyword">USING</span> (auth.role() = <span class="string">'service_role'</span>);

<span class="keyword">CREATE POLICY</span> <span class="string">"Service role full access subscriptions"</span>
    <span class="keyword">ON</span> public.subscriptions <span class="keyword">FOR ALL</span>
    <span class="keyword">USING</span> (auth.role() = <span class="string">'service_role'</span>);

<span class="comment">-- Function to handle new user signup</span>
<span class="keyword">CREATE OR REPLACE FUNCTION</span> <span class="function">public.handle_new_user</span>()
<span class="keyword">RETURNS TRIGGER AS</span> $$
<span class="keyword">BEGIN</span>
    <span class="keyword">INSERT INTO</span> public.users (id, email, full_name, avatar_url)
    <span class="keyword">VALUES</span> (
        NEW.id,
        NEW.email,
        NEW.raw_user_meta_data->><span class="string">'full_name'</span>,
        NEW.raw_user_meta_data->><span class="string">'avatar_url'</span>
    );

    <span class="comment">-- Create free subscription by default</span>
    <span class="keyword">INSERT INTO</span> public.subscriptions (user_id, status, plan)
    <span class="keyword">VALUES</span> (NEW.id, <span class="string">'free'</span>, <span class="string">'free'</span>);

    <span class="keyword">RETURN</span> NEW;
<span class="keyword">END</span>;
$$ <span class="keyword">LANGUAGE</span> plpgsql <span class="keyword">SECURITY DEFINER</span>;

<span class="comment">-- Trigger for new user signup</span>
<span class="keyword">CREATE TRIGGER</span> on_auth_user_created
    <span class="keyword">AFTER INSERT ON</span> auth.users
    <span class="keyword">FOR EACH ROW EXECUTE FUNCTION</span> public.handle_new_user();</code></pre>
        </section>

        <!-- Section 5: Authentication -->
        <section id="auth" class="section">
            <div class="section-header">
                <div class="section-number">5</div>
                <h2 class="section-title">Authentication Setup</h2>
            </div>

            <h3>Step 1: Supabase Client Setup</h3>
            <p>Create <code>lib/supabase-client.ts</code>:</p>
            <pre><code><span class="keyword">import</span> { createBrowserClient } <span class="keyword">from</span> <span class="string">'@supabase/ssr'</span>;

<span class="keyword">export function</span> <span class="function">createClient</span>() {
    <span class="keyword">return</span> <span class="function">createBrowserClient</span>(
        process.env.<span class="variable">NEXT_PUBLIC_SUPABASE_URL</span>!,
        process.env.<span class="variable">NEXT_PUBLIC_SUPABASE_ANON_KEY</span>!
    );
}</code></pre>

            <h3>Step 2: Server Client for API Routes</h3>
            <p>Create <code>lib/supabase-server.ts</code>:</p>
            <pre><code><span class="keyword">import</span> { createServerClient } <span class="keyword">from</span> <span class="string">'@supabase/ssr'</span>;
<span class="keyword">import</span> { cookies } <span class="keyword">from</span> <span class="string">'next/headers'</span>;

<span class="keyword">export async function</span> <span class="function">createServerSupabaseClient</span>() {
    <span class="keyword">const</span> cookieStore = <span class="keyword">await</span> <span class="function">cookies</span>();

    <span class="keyword">return</span> <span class="function">createServerClient</span>(
        process.env.<span class="variable">NEXT_PUBLIC_SUPABASE_URL</span>!,
        process.env.<span class="variable">NEXT_PUBLIC_SUPABASE_ANON_KEY</span>!,
        {
            cookies: {
                <span class="function">get</span>(name: <span class="variable">string</span>) {
                    <span class="keyword">return</span> cookieStore.<span class="function">get</span>(name)?.<span class="property">value</span>;
                },
                <span class="function">set</span>(name: <span class="variable">string</span>, value: <span class="variable">string</span>, options: <span class="variable">any</span>) {
                    cookieStore.<span class="function">set</span>({ name, value, ...options });
                },
                <span class="function">remove</span>(name: <span class="variable">string</span>, options: <span class="variable">any</span>) {
                    cookieStore.<span class="function">set</span>({ name, value: <span class="string">''</span>, ...options });
                },
            },
        }
    );
}

<span class="comment">// Admin client for webhooks (bypasses RLS)</span>
<span class="keyword">import</span> { createClient } <span class="keyword">from</span> <span class="string">'@supabase/supabase-js'</span>;

<span class="keyword">export function</span> <span class="function">createAdminClient</span>() {
    <span class="keyword">return</span> <span class="function">createClient</span>(
        process.env.<span class="variable">NEXT_PUBLIC_SUPABASE_URL</span>!,
        process.env.<span class="variable">SUPABASE_SERVICE_ROLE_KEY</span>!,
        { auth: { persistSession: <span class="keyword">false</span> } }
    );
}</code></pre>

            <h3>Step 3: Auth Callback Route</h3>
            <p>Create <code>app/api/auth/callback/route.ts</code>:</p>
            <pre><code><span class="keyword">import</span> { createServerSupabaseClient } <span class="keyword">from</span> <span class="string">'@/lib/supabase-server'</span>;
<span class="keyword">import</span> { NextResponse } <span class="keyword">from</span> <span class="string">'next/server'</span>;

<span class="keyword">export async function</span> <span class="function">GET</span>(request: <span class="variable">Request</span>) {
    <span class="keyword">const</span> { searchParams, origin } = <span class="keyword">new</span> <span class="function">URL</span>(request.url);
    <span class="keyword">const</span> code = searchParams.<span class="function">get</span>(<span class="string">'code'</span>);
    <span class="keyword">const</span> next = searchParams.<span class="function">get</span>(<span class="string">'next'</span>) ?? <span class="string">'/'</span>;

    <span class="keyword">if</span> (code) {
        <span class="keyword">const</span> supabase = <span class="keyword">await</span> <span class="function">createServerSupabaseClient</span>();
        <span class="keyword">const</span> { error } = <span class="keyword">await</span> supabase.auth.<span class="function">exchangeCodeForSession</span>(code);

        <span class="keyword">if</span> (!error) {
            <span class="keyword">return</span> NextResponse.<span class="function">redirect</span>(<span class="string">`</span>${origin}${next}<span class="string">`</span>);
        }
    }

    <span class="keyword">return</span> NextResponse.<span class="function">redirect</span>(<span class="string">`</span>${origin}<span class="string">/auth/error`</span>);
}</code></pre>

            <h3>Step 4: Login Page Component</h3>
            <p>Create <code>app/(auth)/login/page.tsx</code>:</p>
            <pre><code><span class="string">'use client'</span>;

<span class="keyword">import</span> { useState } <span class="keyword">from</span> <span class="string">'react'</span>;
<span class="keyword">import</span> { createClient } <span class="keyword">from</span> <span class="string">'@/lib/supabase-client'</span>;
<span class="keyword">import</span> { useRouter } <span class="keyword">from</span> <span class="string">'next/navigation'</span>;

<span class="keyword">export default function</span> <span class="function">LoginPage</span>() {
    <span class="keyword">const</span> [email, setEmail] = <span class="function">useState</span>(<span class="string">''</span>);
    <span class="keyword">const</span> [password, setPassword] = <span class="function">useState</span>(<span class="string">''</span>);
    <span class="keyword">const</span> [loading, setLoading] = <span class="function">useState</span>(<span class="keyword">false</span>);
    <span class="keyword">const</span> [error, setError] = <span class="function">useState</span>(<span class="string">''</span>);
    <span class="keyword">const</span> router = <span class="function">useRouter</span>();
    <span class="keyword">const</span> supabase = <span class="function">createClient</span>();

    <span class="keyword">const</span> <span class="function">handleLogin</span> = <span class="keyword">async</span> (e: React.FormEvent) => {
        e.<span class="function">preventDefault</span>();
        <span class="function">setLoading</span>(<span class="keyword">true</span>);
        <span class="function">setError</span>(<span class="string">''</span>);

        <span class="keyword">const</span> { error } = <span class="keyword">await</span> supabase.auth.<span class="function">signInWithPassword</span>({
            email,
            password,
        });

        <span class="keyword">if</span> (error) {
            <span class="function">setError</span>(error.message);
            <span class="function">setLoading</span>(<span class="keyword">false</span>);
        } <span class="keyword">else</span> {
            router.<span class="function">push</span>(<span class="string">'/'</span>);
            router.<span class="function">refresh</span>();
        }
    };

    <span class="keyword">const</span> <span class="function">handleGoogleLogin</span> = <span class="keyword">async</span> () => {
        <span class="keyword">await</span> supabase.auth.<span class="function">signInWithOAuth</span>({
            provider: <span class="string">'google'</span>,
            options: {
                redirectTo: <span class="string">`</span>${window.location.origin}<span class="string">/api/auth/callback`</span>,
            },
        });
    };

    <span class="keyword">return</span> (
        <span class="keyword">&lt;div</span> className=<span class="string">"min-h-screen flex items-center justify-center"</span><span class="keyword">&gt;</span>
            <span class="keyword">&lt;form</span> onSubmit={handleLogin} className=<span class="string">"w-full max-w-md p-8"</span><span class="keyword">&gt;</span>
                <span class="keyword">&lt;h1</span> className=<span class="string">"text-2xl font-bold mb-6"</span><span class="keyword">&gt;</span>Sign In<span class="keyword">&lt;/h1&gt;</span>

                {error && <span class="keyword">&lt;div</span> className=<span class="string">"text-red-500 mb-4"</span><span class="keyword">&gt;</span>{error}<span class="keyword">&lt;/div&gt;</span>}

                <span class="keyword">&lt;input</span>
                    type=<span class="string">"email"</span>
                    value={email}
                    onChange={(e) => <span class="function">setEmail</span>(e.target.value)}
                    placeholder=<span class="string">"Email"</span>
                    className=<span class="string">"w-full p-3 mb-4 border rounded"</span>
                    required
                <span class="keyword">/&gt;</span>

                <span class="keyword">&lt;input</span>
                    type=<span class="string">"password"</span>
                    value={password}
                    onChange={(e) => <span class="function">setPassword</span>(e.target.value)}
                    placeholder=<span class="string">"Password"</span>
                    className=<span class="string">"w-full p-3 mb-4 border rounded"</span>
                    required
                <span class="keyword">/&gt;</span>

                <span class="keyword">&lt;button</span>
                    type=<span class="string">"submit"</span>
                    disabled={loading}
                    className=<span class="string">"w-full p-3 bg-purple-600 text-white rounded"</span>
                <span class="keyword">&gt;</span>
                    {loading ? <span class="string">'Signing in...'</span> : <span class="string">'Sign In'</span>}
                <span class="keyword">&lt;/button&gt;</span>

                <span class="keyword">&lt;button</span>
                    type=<span class="string">"button"</span>
                    onClick={handleGoogleLogin}
                    className=<span class="string">"w-full p-3 mt-4 border rounded"</span>
                <span class="keyword">&gt;</span>
                    Continue with Google
                <span class="keyword">&lt;/button&gt;</span>
            <span class="keyword">&lt;/form&gt;</span>
        <span class="keyword">&lt;/div&gt;</span>
    );
}</code></pre>
        </section>

        <!-- Section 6: Stripe Setup -->
        <section id="stripe" class="section">
            <div class="section-header">
                <div class="section-number">6</div>
                <h2 class="section-title">Stripe Setup</h2>
            </div>

            <h3>Step 1: Create Stripe Account</h3>
            <div class="step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <h4>Go to stripe.com</h4>
                    <p>Create account ‚Üí Get API keys from Dashboard ‚Üí Developers ‚Üí API keys</p>
                </div>
            </div>

            <h3>Step 2: Create Products & Prices</h3>
            <p>In Stripe Dashboard ‚Üí Products ‚Üí Add Product:</p>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Price</th>
                            <th>Billing</th>
                            <th>Price ID</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>SnapBeautify Pro</td>
                            <td>$9.00</td>
                            <td>Monthly recurring</td>
                            <td><code>price_monthly_xxx</code></td>
                        </tr>
                        <tr>
                            <td>SnapBeautify Pro</td>
                            <td>$79.00</td>
                            <td>Yearly recurring</td>
                            <td><code>price_yearly_xxx</code></td>
                        </tr>
                        <tr>
                            <td>SnapBeautify Pro Lifetime</td>
                            <td>$149.00</td>
                            <td>One-time</td>
                            <td><code>price_lifetime_xxx</code></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>Step 3: Stripe Client Library</h3>
            <p>Create <code>lib/stripe.ts</code>:</p>
            <pre><code><span class="keyword">import</span> Stripe <span class="keyword">from</span> <span class="string">'stripe'</span>;

<span class="keyword">export const</span> stripe = <span class="keyword">new</span> <span class="function">Stripe</span>(process.env.<span class="variable">STRIPE_SECRET_KEY</span>!, {
    apiVersion: <span class="string">'2023-10-16'</span>,
    typescript: <span class="keyword">true</span>,
});

<span class="keyword">export const</span> PLANS = {
    free: {
        name: <span class="string">'Free'</span>,
        price: <span class="number">0</span>,
        priceId: <span class="keyword">null</span>,
    },
    pro_monthly: {
        name: <span class="string">'Pro Monthly'</span>,
        price: <span class="number">9</span>,
        priceId: process.env.<span class="variable">STRIPE_PRICE_MONTHLY</span>,
        interval: <span class="string">'month'</span>,
    },
    pro_yearly: {
        name: <span class="string">'Pro Yearly'</span>,
        price: <span class="number">79</span>,
        priceId: process.env.<span class="variable">STRIPE_PRICE_YEARLY</span>,
        interval: <span class="string">'year'</span>,
    },
    pro_lifetime: {
        name: <span class="string">'Pro Lifetime'</span>,
        price: <span class="number">149</span>,
        priceId: process.env.<span class="variable">STRIPE_PRICE_LIFETIME</span>,
        interval: <span class="keyword">null</span>,
    },
} <span class="keyword">as const</span>;

<span class="keyword">export type</span> PlanType = <span class="keyword">keyof typeof</span> PLANS;</code></pre>
        </section>

        <!-- Section 7: API Routes -->
        <section id="api" class="section">
            <div class="section-header">
                <div class="section-number">7</div>
                <h2 class="section-title">API Routes (Vercel Serverless)</h2>
            </div>

            <h3>Create Checkout Session</h3>
            <p>Create <code>app/api/stripe/create-checkout/route.ts</code>:</p>
            <pre><code><span class="keyword">import</span> { NextResponse } <span class="keyword">from</span> <span class="string">'next/server'</span>;
<span class="keyword">import</span> { stripe, PLANS } <span class="keyword">from</span> <span class="string">'@/lib/stripe'</span>;
<span class="keyword">import</span> { createServerSupabaseClient, createAdminClient } <span class="keyword">from</span> <span class="string">'@/lib/supabase-server'</span>;

<span class="keyword">export async function</span> <span class="function">POST</span>(request: <span class="variable">Request</span>) {
    <span class="keyword">try</span> {
        <span class="keyword">const</span> { priceId, plan } = <span class="keyword">await</span> request.<span class="function">json</span>();

        <span class="comment">// Get authenticated user</span>
        <span class="keyword">const</span> supabase = <span class="keyword">await</span> <span class="function">createServerSupabaseClient</span>();
        <span class="keyword">const</span> { data: { user }, error: authError } = <span class="keyword">await</span> supabase.auth.<span class="function">getUser</span>();

        <span class="keyword">if</span> (authError || !user) {
            <span class="keyword">return</span> NextResponse.<span class="function">json</span>(
                { error: <span class="string">'Unauthorized'</span> },
                { status: <span class="number">401</span> }
            );
        }

        <span class="comment">// Get or create Stripe customer</span>
        <span class="keyword">const</span> adminSupabase = <span class="function">createAdminClient</span>();
        <span class="keyword">const</span> { data: userData } = <span class="keyword">await</span> adminSupabase
            .<span class="function">from</span>(<span class="string">'users'</span>)
            .<span class="function">select</span>(<span class="string">'stripe_customer_id'</span>)
            .<span class="function">eq</span>(<span class="string">'id'</span>, user.id)
            .<span class="function">single</span>();

        <span class="keyword">let</span> customerId = userData?.stripe_customer_id;

        <span class="keyword">if</span> (!customerId) {
            <span class="comment">// Create new Stripe customer</span>
            <span class="keyword">const</span> customer = <span class="keyword">await</span> stripe.customers.<span class="function">create</span>({
                email: user.email,
                metadata: { supabase_user_id: user.id },
            });
            customerId = customer.id;

            <span class="comment">// Save customer ID to database</span>
            <span class="keyword">await</span> adminSupabase
                .<span class="function">from</span>(<span class="string">'users'</span>)
                .<span class="function">update</span>({ stripe_customer_id: customerId })
                .<span class="function">eq</span>(<span class="string">'id'</span>, user.id);
        }

        <span class="comment">// Determine if this is a subscription or one-time payment</span>
        <span class="keyword">const</span> isLifetime = plan === <span class="string">'pro_lifetime'</span>;

        <span class="comment">// Create Checkout Session</span>
        <span class="keyword">const</span> session = <span class="keyword">await</span> stripe.checkout.sessions.<span class="function">create</span>({
            customer: customerId,
            mode: isLifetime ? <span class="string">'payment'</span> : <span class="string">'subscription'</span>,
            payment_method_types: [<span class="string">'card'</span>],
            line_items: [
                {
                    price: priceId,
                    quantity: <span class="number">1</span>,
                },
            ],
            success_url: <span class="string">`</span>${process.env.<span class="variable">NEXT_PUBLIC_APP_URL</span>}<span class="string">/success?session_id={CHECKOUT_SESSION_ID}`</span>,
            cancel_url: <span class="string">`</span>${process.env.<span class="variable">NEXT_PUBLIC_APP_URL</span>}<span class="string">/pricing`</span>,
            metadata: {
                user_id: user.id,
                plan: plan,
            },
            <span class="comment">// For subscriptions, allow customer to update payment method</span>
            ...(isLifetime ? {} : {
                subscription_data: {
                    metadata: {
                        user_id: user.id,
                        plan: plan,
                    },
                },
            }),
        });

        <span class="keyword">return</span> NextResponse.<span class="function">json</span>({ url: session.url });
    } <span class="keyword">catch</span> (error: <span class="variable">any</span>) {
        console.<span class="function">error</span>(<span class="string">'Checkout error:'</span>, error);
        <span class="keyword">return</span> NextResponse.<span class="function">json</span>(
            { error: error.message },
            { status: <span class="number">500</span> }
        );
    }
}</code></pre>

            <h3>Create Customer Portal Session</h3>
            <p>Create <code>app/api/stripe/create-portal/route.ts</code>:</p>
            <pre><code><span class="keyword">import</span> { NextResponse } <span class="keyword">from</span> <span class="string">'next/server'</span>;
<span class="keyword">import</span> { stripe } <span class="keyword">from</span> <span class="string">'@/lib/stripe'</span>;
<span class="keyword">import</span> { createServerSupabaseClient, createAdminClient } <span class="keyword">from</span> <span class="string">'@/lib/supabase-server'</span>;

<span class="keyword">export async function</span> <span class="function">POST</span>(request: <span class="variable">Request</span>) {
    <span class="keyword">try</span> {
        <span class="keyword">const</span> supabase = <span class="keyword">await</span> <span class="function">createServerSupabaseClient</span>();
        <span class="keyword">const</span> { data: { user } } = <span class="keyword">await</span> supabase.auth.<span class="function">getUser</span>();

        <span class="keyword">if</span> (!user) {
            <span class="keyword">return</span> NextResponse.<span class="function">json</span>({ error: <span class="string">'Unauthorized'</span> }, { status: <span class="number">401</span> });
        }

        <span class="comment">// Get customer ID</span>
        <span class="keyword">const</span> adminSupabase = <span class="function">createAdminClient</span>();
        <span class="keyword">const</span> { data: userData } = <span class="keyword">await</span> adminSupabase
            .<span class="function">from</span>(<span class="string">'users'</span>)
            .<span class="function">select</span>(<span class="string">'stripe_customer_id'</span>)
            .<span class="function">eq</span>(<span class="string">'id'</span>, user.id)
            .<span class="function">single</span>();

        <span class="keyword">if</span> (!userData?.stripe_customer_id) {
            <span class="keyword">return</span> NextResponse.<span class="function">json</span>(
                { error: <span class="string">'No subscription found'</span> },
                { status: <span class="number">400</span> }
            );
        }

        <span class="comment">// Create portal session</span>
        <span class="keyword">const</span> session = <span class="keyword">await</span> stripe.billingPortal.sessions.<span class="function">create</span>({
            customer: userData.stripe_customer_id,
            return_url: <span class="string">`</span>${process.env.<span class="variable">NEXT_PUBLIC_APP_URL</span>}<span class="string">/settings`</span>,
        });

        <span class="keyword">return</span> NextResponse.<span class="function">json</span>({ url: session.url });
    } <span class="keyword">catch</span> (error: <span class="variable">any</span>) {
        <span class="keyword">return</span> NextResponse.<span class="function">json</span>({ error: error.message }, { status: <span class="number">500</span> });
    }
}</code></pre>

            <h3>Get User Subscription</h3>
            <p>Create <code>app/api/user/subscription/route.ts</code>:</p>
            <pre><code><span class="keyword">import</span> { NextResponse } <span class="keyword">from</span> <span class="string">'next/server'</span>;
<span class="keyword">import</span> { createServerSupabaseClient } <span class="keyword">from</span> <span class="string">'@/lib/supabase-server'</span>;

<span class="keyword">export async function</span> <span class="function">GET</span>() {
    <span class="keyword">try</span> {
        <span class="keyword">const</span> supabase = <span class="keyword">await</span> <span class="function">createServerSupabaseClient</span>();
        <span class="keyword">const</span> { data: { user } } = <span class="keyword">await</span> supabase.auth.<span class="function">getUser</span>();

        <span class="keyword">if</span> (!user) {
            <span class="keyword">return</span> NextResponse.<span class="function">json</span>({
                plan: <span class="string">'free'</span>,
                status: <span class="string">'free'</span>,
                isPro: <span class="keyword">false</span>,
            });
        }

        <span class="keyword">const</span> { data: subscription } = <span class="keyword">await</span> supabase
            .<span class="function">from</span>(<span class="string">'subscriptions'</span>)
            .<span class="function">select</span>(<span class="string">'*'</span>)
            .<span class="function">eq</span>(<span class="string">'user_id'</span>, user.id)
            .<span class="function">single</span>();

        <span class="keyword">const</span> isPro = subscription?.status === <span class="string">'active'</span> ||
                      subscription?.status === <span class="string">'lifetime'</span>;

        <span class="keyword">return</span> NextResponse.<span class="function">json</span>({
            plan: subscription?.plan || <span class="string">'free'</span>,
            status: subscription?.status || <span class="string">'free'</span>,
            isPro,
            currentPeriodEnd: subscription?.current_period_end,
            cancelAtPeriodEnd: subscription?.cancel_at_period_end,
        });
    } <span class="keyword">catch</span> (error) {
        <span class="keyword">return</span> NextResponse.<span class="function">json</span>({
            plan: <span class="string">'free'</span>,
            status: <span class="string">'free'</span>,
            isPro: <span class="keyword">false</span>,
        });
    }
}</code></pre>
        </section>

        <!-- Section 8: Webhooks -->
        <section id="webhooks" class="section">
            <div class="section-header">
                <div class="section-number">8</div>
                <h2 class="section-title">Stripe Webhooks</h2>
            </div>

            <div class="alert alert-danger">
                <span class="alert-icon">üö®</span>
                <div>
                    <strong>Critical:</strong> Webhooks are essential! They're how Stripe tells your app about payment events. Without webhooks, subscriptions won't be activated.
                </div>
            </div>

            <h3>Webhook Handler</h3>
            <p>Create <code>app/api/stripe/webhook/route.ts</code>:</p>
            <pre><code><span class="keyword">import</span> { NextResponse } <span class="keyword">from</span> <span class="string">'next/server'</span>;
<span class="keyword">import</span> { headers } <span class="keyword">from</span> <span class="string">'next/headers'</span>;
<span class="keyword">import</span> { stripe } <span class="keyword">from</span> <span class="string">'@/lib/stripe'</span>;
<span class="keyword">import</span> { createAdminClient } <span class="keyword">from</span> <span class="string">'@/lib/supabase-server'</span>;
<span class="keyword">import</span> Stripe <span class="keyword">from</span> <span class="string">'stripe'</span>;

<span class="keyword">export async function</span> <span class="function">POST</span>(request: <span class="variable">Request</span>) {
    <span class="keyword">const</span> body = <span class="keyword">await</span> request.<span class="function">text</span>();
    <span class="keyword">const</span> headersList = <span class="keyword">await</span> <span class="function">headers</span>();
    <span class="keyword">const</span> signature = headersList.<span class="function">get</span>(<span class="string">'stripe-signature'</span>)!;

    <span class="keyword">let</span> event: Stripe.Event;

    <span class="keyword">try</span> {
        event = stripe.webhooks.<span class="function">constructEvent</span>(
            body,
            signature,
            process.env.<span class="variable">STRIPE_WEBHOOK_SECRET</span>!
        );
    } <span class="keyword">catch</span> (err: <span class="variable">any</span>) {
        console.<span class="function">error</span>(<span class="string">'Webhook signature verification failed:'</span>, err.message);
        <span class="keyword">return</span> NextResponse.<span class="function">json</span>(
            { error: <span class="string">'Invalid signature'</span> },
            { status: <span class="number">400</span> }
        );
    }

    <span class="keyword">const</span> supabase = <span class="function">createAdminClient</span>();

    <span class="keyword">try</span> {
        <span class="keyword">switch</span> (event.type) {
            <span class="comment">// Subscription created or updated</span>
            <span class="keyword">case</span> <span class="string">'customer.subscription.created'</span>:
            <span class="keyword">case</span> <span class="string">'customer.subscription.updated'</span>: {
                <span class="keyword">const</span> subscription = event.data.object <span class="keyword">as</span> Stripe.Subscription;
                <span class="keyword">const</span> userId = subscription.metadata.user_id;
                <span class="keyword">const</span> plan = subscription.metadata.plan;

                <span class="keyword">await</span> supabase
                    .<span class="function">from</span>(<span class="string">'subscriptions'</span>)
                    .<span class="function">upsert</span>({
                        user_id: userId,
                        stripe_subscription_id: subscription.id,
                        stripe_price_id: subscription.items.data[<span class="number">0</span>].price.id,
                        status: subscription.status === <span class="string">'active'</span> ? <span class="string">'active'</span> : subscription.status,
                        plan: plan,
                        current_period_start: <span class="keyword">new</span> <span class="function">Date</span>(subscription.current_period_start * <span class="number">1000</span>).<span class="function">toISOString</span>(),
                        current_period_end: <span class="keyword">new</span> <span class="function">Date</span>(subscription.current_period_end * <span class="number">1000</span>).<span class="function">toISOString</span>(),
                        cancel_at_period_end: subscription.cancel_at_period_end,
                        updated_at: <span class="keyword">new</span> <span class="function">Date</span>().<span class="function">toISOString</span>(),
                    }, {
                        onConflict: <span class="string">'user_id'</span>,
                    });
                <span class="keyword">break</span>;
            }

            <span class="comment">// Subscription deleted/canceled</span>
            <span class="keyword">case</span> <span class="string">'customer.subscription.deleted'</span>: {
                <span class="keyword">const</span> subscription = event.data.object <span class="keyword">as</span> Stripe.Subscription;
                <span class="keyword">const</span> userId = subscription.metadata.user_id;

                <span class="keyword">await</span> supabase
                    .<span class="function">from</span>(<span class="string">'subscriptions'</span>)
                    .<span class="function">update</span>({
                        status: <span class="string">'canceled'</span>,
                        plan: <span class="string">'free'</span>,
                        updated_at: <span class="keyword">new</span> <span class="function">Date</span>().<span class="function">toISOString</span>(),
                    })
                    .<span class="function">eq</span>(<span class="string">'user_id'</span>, userId);
                <span class="keyword">break</span>;
            }

            <span class="comment">// One-time payment completed (for lifetime)</span>
            <span class="keyword">case</span> <span class="string">'checkout.session.completed'</span>: {
                <span class="keyword">const</span> session = event.data.object <span class="keyword">as</span> Stripe.Checkout.Session;

                <span class="comment">// Only process one-time payments (lifetime)</span>
                <span class="keyword">if</span> (session.mode === <span class="string">'payment'</span>) {
                    <span class="keyword">const</span> userId = session.metadata?.user_id;
                    <span class="keyword">const</span> plan = session.metadata?.plan;

                    <span class="keyword">if</span> (userId && plan === <span class="string">'pro_lifetime'</span>) {
                        <span class="keyword">await</span> supabase
                            .<span class="function">from</span>(<span class="string">'subscriptions'</span>)
                            .<span class="function">upsert</span>({
                                user_id: userId,
                                status: <span class="string">'lifetime'</span>,
                                plan: <span class="string">'pro_lifetime'</span>,
                                updated_at: <span class="keyword">new</span> <span class="function">Date</span>().<span class="function">toISOString</span>(),
                            }, {
                                onConflict: <span class="string">'user_id'</span>,
                            });
                    }
                }
                <span class="keyword">break</span>;
            }

            <span class="comment">// Payment failed</span>
            <span class="keyword">case</span> <span class="string">'invoice.payment_failed'</span>: {
                <span class="keyword">const</span> invoice = event.data.object <span class="keyword">as</span> Stripe.Invoice;
                <span class="keyword">const</span> subscriptionId = invoice.subscription <span class="keyword">as</span> <span class="variable">string</span>;

                <span class="keyword">await</span> supabase
                    .<span class="function">from</span>(<span class="string">'subscriptions'</span>)
                    .<span class="function">update</span>({
                        status: <span class="string">'past_due'</span>,
                        updated_at: <span class="keyword">new</span> <span class="function">Date</span>().<span class="function">toISOString</span>(),
                    })
                    .<span class="function">eq</span>(<span class="string">'stripe_subscription_id'</span>, subscriptionId);
                <span class="keyword">break</span>;
            }

            <span class="keyword">default</span>:
                console.<span class="function">log</span>(<span class="string">`Unhandled event type: </span>${event.type}<span class="string">`</span>);
        }

        <span class="keyword">return</span> NextResponse.<span class="function">json</span>({ received: <span class="keyword">true</span> });
    } <span class="keyword">catch</span> (error) {
        console.<span class="function">error</span>(<span class="string">'Webhook handler error:'</span>, error);
        <span class="keyword">return</span> NextResponse.<span class="function">json</span>(
            { error: <span class="string">'Webhook handler failed'</span> },
            { status: <span class="number">500</span> }
        );
    }
}</code></pre>

            <h3>Configure Webhook in Stripe Dashboard</h3>
            <div class="step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <h4>Go to Stripe Dashboard ‚Üí Developers ‚Üí Webhooks</h4>
                    <p>Click "Add endpoint"</p>
                </div>
            </div>
            <div class="step">
                <div class="step-number">2</div>
                <div class="step-content">
                    <h4>Endpoint URL</h4>
                    <p><code>https://your-domain.vercel.app/api/stripe/webhook</code></p>
                </div>
            </div>
            <div class="step">
                <div class="step-number">3</div>
                <div class="step-content">
                    <h4>Select Events</h4>
                    <p>customer.subscription.created, customer.subscription.updated, customer.subscription.deleted, checkout.session.completed, invoice.payment_failed</p>
                </div>
            </div>
            <div class="step">
                <div class="step-number">4</div>
                <div class="step-content">
                    <h4>Copy Webhook Secret</h4>
                    <p>Save as <code>STRIPE_WEBHOOK_SECRET</code> in environment variables</p>
                </div>
            </div>
        </section>

        <!-- Section 9: Frontend -->
        <section id="frontend" class="section">
            <div class="section-header">
                <div class="section-number">9</div>
                <h2 class="section-title">Frontend Implementation</h2>
            </div>

            <h3>Subscription Hook</h3>
            <p>Create <code>lib/hooks/useSubscription.ts</code>:</p>
            <pre><code><span class="string">'use client'</span>;

<span class="keyword">import</span> { useState, useEffect, useCallback } <span class="keyword">from</span> <span class="string">'react'</span>;

<span class="keyword">interface</span> Subscription {
    plan: <span class="variable">string</span>;
    status: <span class="variable">string</span>;
    isPro: <span class="variable">boolean</span>;
    currentPeriodEnd?: <span class="variable">string</span>;
    cancelAtPeriodEnd?: <span class="variable">boolean</span>;
}

<span class="keyword">export function</span> <span class="function">useSubscription</span>() {
    <span class="keyword">const</span> [subscription, setSubscription] = <span class="function">useState</span>&lt;Subscription | <span class="keyword">null</span>&gt;(<span class="keyword">null</span>);
    <span class="keyword">const</span> [loading, setLoading] = <span class="function">useState</span>(<span class="keyword">true</span>);

    <span class="keyword">const</span> <span class="function">fetchSubscription</span> = <span class="function">useCallback</span>(<span class="keyword">async</span> () => {
        <span class="keyword">try</span> {
            <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="function">fetch</span>(<span class="string">'/api/user/subscription'</span>);
            <span class="keyword">const</span> data = <span class="keyword">await</span> response.<span class="function">json</span>();
            <span class="function">setSubscription</span>(data);
        } <span class="keyword">catch</span> (error) {
            <span class="function">setSubscription</span>({ plan: <span class="string">'free'</span>, status: <span class="string">'free'</span>, isPro: <span class="keyword">false</span> });
        } <span class="keyword">finally</span> {
            <span class="function">setLoading</span>(<span class="keyword">false</span>);
        }
    }, []);

    <span class="function">useEffect</span>(() => {
        <span class="function">fetchSubscription</span>();
    }, [fetchSubscription]);

    <span class="keyword">const</span> <span class="function">checkout</span> = <span class="keyword">async</span> (priceId: <span class="variable">string</span>, plan: <span class="variable">string</span>) => {
        <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="function">fetch</span>(<span class="string">'/api/stripe/create-checkout'</span>, {
            method: <span class="string">'POST'</span>,
            headers: { <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span> },
            body: JSON.<span class="function">stringify</span>({ priceId, plan }),
        });

        <span class="keyword">const</span> { url, error } = <span class="keyword">await</span> response.<span class="function">json</span>();

        <span class="keyword">if</span> (error) <span class="keyword">throw new</span> <span class="function">Error</span>(error);
        <span class="keyword">if</span> (url) window.location.href = url;
    };

    <span class="keyword">const</span> <span class="function">openPortal</span> = <span class="keyword">async</span> () => {
        <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="function">fetch</span>(<span class="string">'/api/stripe/create-portal'</span>, {
            method: <span class="string">'POST'</span>,
        });

        <span class="keyword">const</span> { url, error } = <span class="keyword">await</span> response.<span class="function">json</span>();

        <span class="keyword">if</span> (error) <span class="keyword">throw new</span> <span class="function">Error</span>(error);
        <span class="keyword">if</span> (url) window.location.href = url;
    };

    <span class="keyword">return</span> {
        subscription,
        loading,
        isPro: subscription?.isPro ?? <span class="keyword">false</span>,
        checkout,
        openPortal,
        refetch: fetchSubscription,
    };
}</code></pre>

            <h3>Pricing Page</h3>
            <p>Create <code>app/pricing/page.tsx</code>:</p>
            <pre><code><span class="string">'use client'</span>;

<span class="keyword">import</span> { useSubscription } <span class="keyword">from</span> <span class="string">'@/lib/hooks/useSubscription'</span>;
<span class="keyword">import</span> { PLANS } <span class="keyword">from</span> <span class="string">'@/lib/stripe'</span>;

<span class="keyword">export default function</span> <span class="function">PricingPage</span>() {
    <span class="keyword">const</span> { subscription, loading, checkout, openPortal } = <span class="function">useSubscription</span>();

    <span class="keyword">const</span> <span class="function">handleUpgrade</span> = <span class="keyword">async</span> (plan: <span class="variable">string</span>) => {
        <span class="keyword">const</span> planData = PLANS[plan <span class="keyword">as keyof typeof</span> PLANS];
        <span class="keyword">if</span> (planData.priceId) {
            <span class="keyword">await</span> <span class="function">checkout</span>(planData.priceId, plan);
        }
    };

    <span class="keyword">if</span> (loading) {
        <span class="keyword">return</span> <span class="keyword">&lt;div&gt;</span>Loading...<span class="keyword">&lt;/div&gt;</span>;
    }

    <span class="keyword">return</span> (
        <span class="keyword">&lt;div</span> className=<span class="string">"max-w-6xl mx-auto py-16 px-4"</span><span class="keyword">&gt;</span>
            <span class="keyword">&lt;h1</span> className=<span class="string">"text-4xl font-bold text-center mb-12"</span><span class="keyword">&gt;</span>
                Choose Your Plan
            <span class="keyword">&lt;/h1&gt;</span>

            <span class="keyword">&lt;div</span> className=<span class="string">"grid md:grid-cols-3 gap-8"</span><span class="keyword">&gt;</span>
                {<span class="comment">/* Free Plan */</span>}
                <span class="keyword">&lt;div</span> className=<span class="string">"border rounded-2xl p-8"</span><span class="keyword">&gt;</span>
                    <span class="keyword">&lt;h2</span> className=<span class="string">"text-2xl font-bold"</span><span class="keyword">&gt;</span>Free<span class="keyword">&lt;/h2&gt;</span>
                    <span class="keyword">&lt;p</span> className=<span class="string">"text-4xl font-bold mt-4"</span><span class="keyword">&gt;</span>$0<span class="keyword">&lt;/p&gt;</span>
                    <span class="keyword">&lt;ul</span> className=<span class="string">"mt-8 space-y-4"</span><span class="keyword">&gt;</span>
                        <span class="keyword">&lt;li&gt;</span>‚úì Basic backgrounds<span class="keyword">&lt;/li&gt;</span>
                        <span class="keyword">&lt;li&gt;</span>‚úì Browser frame<span class="keyword">&lt;/li&gt;</span>
                        <span class="keyword">&lt;li&gt;</span>‚úì 1 text overlay<span class="keyword">&lt;/li&gt;</span>
                        <span class="keyword">&lt;li&gt;</span>‚úì PNG/JPEG export<span class="keyword">&lt;/li&gt;</span>
                    <span class="keyword">&lt;/ul&gt;</span>
                    <span class="keyword">&lt;button</span>
                        disabled
                        className=<span class="string">"w-full mt-8 py-3 rounded-lg bg-gray-100"</span>
                    <span class="keyword">&gt;</span>
                        Current Plan
                    <span class="keyword">&lt;/button&gt;</span>
                <span class="keyword">&lt;/div&gt;</span>

                {<span class="comment">/* Pro Monthly */</span>}
                <span class="keyword">&lt;div</span> className=<span class="string">"border-2 border-purple-500 rounded-2xl p-8 relative"</span><span class="keyword">&gt;</span>
                    <span class="keyword">&lt;span</span> className=<span class="string">"absolute -top-3 left-1/2 -translate-x-1/2 bg-purple-500 text-white px-4 py-1 rounded-full text-sm"</span><span class="keyword">&gt;</span>
                        Popular
                    <span class="keyword">&lt;/span&gt;</span>
                    <span class="keyword">&lt;h2</span> className=<span class="string">"text-2xl font-bold"</span><span class="keyword">&gt;</span>Pro Monthly<span class="keyword">&lt;/h2&gt;</span>
                    <span class="keyword">&lt;p</span> className=<span class="string">"text-4xl font-bold mt-4"</span><span class="keyword">&gt;</span>
                        $9<span class="keyword">&lt;span</span> className=<span class="string">"text-lg"</span><span class="keyword">&gt;</span>/mo<span class="keyword">&lt;/span&gt;</span>
                    <span class="keyword">&lt;/p&gt;</span>
                    <span class="keyword">&lt;ul</span> className=<span class="string">"mt-8 space-y-4"</span><span class="keyword">&gt;</span>
                        <span class="keyword">&lt;li&gt;</span>‚úì All backgrounds & effects<span class="keyword">&lt;/li&gt;</span>
                        <span class="keyword">&lt;li&gt;</span>‚úì All device frames<span class="keyword">&lt;/li&gt;</span>
                        <span class="keyword">&lt;li&gt;</span>‚úì Unlimited text overlays<span class="keyword">&lt;/li&gt;</span>
                        <span class="keyword">&lt;li&gt;</span>‚úì 4x resolution export<span class="keyword">&lt;/li&gt;</span>
                        <span class="keyword">&lt;li&gt;</span>‚úì 47 templates<span class="keyword">&lt;/li&gt;</span>
                    <span class="keyword">&lt;/ul&gt;</span>
                    <span class="keyword">&lt;button</span>
                        onClick={() => <span class="function">handleUpgrade</span>(<span class="string">'pro_monthly'</span>)}
                        className=<span class="string">"w-full mt-8 py-3 rounded-lg bg-purple-600 text-white hover:bg-purple-700"</span>
                    <span class="keyword">&gt;</span>
                        {subscription?.isPro ? <span class="string">'Manage Subscription'</span> : <span class="string">'Upgrade Now'</span>}
                    <span class="keyword">&lt;/button&gt;</span>
                <span class="keyword">&lt;/div&gt;</span>

                {<span class="comment">/* Pro Yearly */</span>}
                <span class="keyword">&lt;div</span> className=<span class="string">"border rounded-2xl p-8"</span><span class="keyword">&gt;</span>
                    <span class="keyword">&lt;h2</span> className=<span class="string">"text-2xl font-bold"</span><span class="keyword">&gt;</span>Pro Yearly<span class="keyword">&lt;/h2&gt;</span>
                    <span class="keyword">&lt;p</span> className=<span class="string">"text-4xl font-bold mt-4"</span><span class="keyword">&gt;</span>
                        $79<span class="keyword">&lt;span</span> className=<span class="string">"text-lg"</span><span class="keyword">&gt;</span>/yr<span class="keyword">&lt;/span&gt;</span>
                    <span class="keyword">&lt;/p&gt;</span>
                    <span class="keyword">&lt;p</span> className=<span class="string">"text-green-500 text-sm"</span><span class="keyword">&gt;</span>Save 27%<span class="keyword">&lt;/p&gt;</span>
                    <span class="keyword">&lt;ul</span> className=<span class="string">"mt-8 space-y-4"</span><span class="keyword">&gt;</span>
                        <span class="keyword">&lt;li&gt;</span>‚úì Everything in Pro<span class="keyword">&lt;/li&gt;</span>
                        <span class="keyword">&lt;li&gt;</span>‚úì ~$6.58/month<span class="keyword">&lt;/li&gt;</span>
                    <span class="keyword">&lt;/ul&gt;</span>
                    <span class="keyword">&lt;button</span>
                        onClick={() => <span class="function">handleUpgrade</span>(<span class="string">'pro_yearly'</span>)}
                        className=<span class="string">"w-full mt-8 py-3 rounded-lg bg-purple-600 text-white"</span>
                    <span class="keyword">&gt;</span>
                        Upgrade Now
                    <span class="keyword">&lt;/button&gt;</span>
                <span class="keyword">&lt;/div&gt;</span>
            <span class="keyword">&lt;/div&gt;</span>

            {subscription?.isPro && (
                <span class="keyword">&lt;div</span> className=<span class="string">"text-center mt-8"</span><span class="keyword">&gt;</span>
                    <span class="keyword">&lt;button</span>
                        onClick={openPortal}
                        className=<span class="string">"text-purple-600 underline"</span>
                    <span class="keyword">&gt;</span>
                        Manage your subscription
                    <span class="keyword">&lt;/button&gt;</span>
                <span class="keyword">&lt;/div&gt;</span>
            )}
        <span class="keyword">&lt;/div&gt;</span>
    );
}</code></pre>
        </section>

        <!-- Section 10: Feature Gating -->
        <section id="feature-gating" class="section">
            <div class="section-header">
                <div class="section-number">10</div>
                <h2 class="section-title">Feature Gating Implementation</h2>
            </div>

            <h3>Subscription Context</h3>
            <p>Create <code>lib/contexts/SubscriptionContext.tsx</code>:</p>
            <pre><code><span class="string">'use client'</span>;

<span class="keyword">import</span> { createContext, useContext, ReactNode } <span class="keyword">from</span> <span class="string">'react'</span>;
<span class="keyword">import</span> { useSubscription } <span class="keyword">from</span> <span class="string">'@/lib/hooks/useSubscription'</span>;

<span class="keyword">interface</span> SubscriptionContextType {
    isPro: <span class="variable">boolean</span>;
    plan: <span class="variable">string</span>;
    loading: <span class="variable">boolean</span>;
    checkout: (priceId: <span class="variable">string</span>, plan: <span class="variable">string</span>) => Promise&lt;<span class="keyword">void</span>&gt;;
    openPortal: () => Promise&lt;<span class="keyword">void</span>&gt;;
}

<span class="keyword">const</span> SubscriptionContext = <span class="function">createContext</span>&lt;SubscriptionContextType | <span class="keyword">undefined</span>&gt;(<span class="keyword">undefined</span>);

<span class="keyword">export function</span> <span class="function">SubscriptionProvider</span>({ children }: { children: ReactNode }) {
    <span class="keyword">const</span> subscription = <span class="function">useSubscription</span>();

    <span class="keyword">return</span> (
        <span class="keyword">&lt;SubscriptionContext.Provider</span> value={{
            isPro: subscription.isPro,
            plan: subscription.subscription?.plan || <span class="string">'free'</span>,
            loading: subscription.loading,
            checkout: subscription.checkout,
            openPortal: subscription.openPortal,
        }}<span class="keyword">&gt;</span>
            {children}
        <span class="keyword">&lt;/SubscriptionContext.Provider&gt;</span>
    );
}

<span class="keyword">export function</span> <span class="function">useSubscriptionContext</span>() {
    <span class="keyword">const</span> context = <span class="function">useContext</span>(SubscriptionContext);
    <span class="keyword">if</span> (!context) {
        <span class="keyword">throw new</span> <span class="function">Error</span>(<span class="string">'useSubscriptionContext must be used within SubscriptionProvider'</span>);
    }
    <span class="keyword">return</span> context;
}</code></pre>

            <h3>Feature Gate Component</h3>
            <p>Create <code>components/FeatureGate.tsx</code>:</p>
            <pre><code><span class="string">'use client'</span>;

<span class="keyword">import</span> { ReactNode, useState } <span class="keyword">from</span> <span class="string">'react'</span>;
<span class="keyword">import</span> { useSubscriptionContext } <span class="keyword">from</span> <span class="string">'@/lib/contexts/SubscriptionContext'</span>;
<span class="keyword">import</span> { Lock } <span class="keyword">from</span> <span class="string">'lucide-react'</span>;

<span class="keyword">interface</span> FeatureGateProps {
    feature: <span class="variable">string</span>;
    children: ReactNode;
    fallback?: ReactNode;
    showLock?: <span class="variable">boolean</span>;
}

<span class="comment">// Define which features require Pro</span>
<span class="keyword">const</span> PRO_FEATURES = [
    <span class="string">'wave_split'</span>,
    <span class="string">'logo_pattern'</span>,
    <span class="string">'text_repeat_mode'</span>,
    <span class="string">'custom_gradient'</span>,
    <span class="string">'device_frames'</span>,
    <span class="string">'unlimited_text_overlays'</span>,
    <span class="string">'gradient_text'</span>,
    <span class="string">'premium_templates'</span>,
    <span class="string">'high_res_export'</span>,
    <span class="string">'social_presets'</span>,
    <span class="string">'all_fonts'</span>,
];

<span class="keyword">export function</span> <span class="function">FeatureGate</span>({
    feature,
    children,
    fallback,
    showLock = <span class="keyword">true</span>
}: FeatureGateProps) {
    <span class="keyword">const</span> { isPro } = <span class="function">useSubscriptionContext</span>();
    <span class="keyword">const</span> [showUpgrade, setShowUpgrade] = <span class="function">useState</span>(<span class="keyword">false</span>);

    <span class="keyword">const</span> requiresPro = PRO_FEATURES.<span class="function">includes</span>(feature);
    <span class="keyword">const</span> hasAccess = !requiresPro || isPro;

    <span class="keyword">if</span> (hasAccess) {
        <span class="keyword">return</span> <span class="keyword">&lt;&gt;</span>{children}<span class="keyword">&lt;/&gt;</span>;
    }

    <span class="keyword">if</span> (fallback) {
        <span class="keyword">return</span> <span class="keyword">&lt;&gt;</span>{fallback}<span class="keyword">&lt;/&gt;</span>;
    }

    <span class="keyword">return</span> (
        <span class="keyword">&lt;div</span>
            className=<span class="string">"relative cursor-pointer group"</span>
            onClick={() => <span class="function">setShowUpgrade</span>(<span class="keyword">true</span>)}
        <span class="keyword">&gt;</span>
            <span class="keyword">&lt;div</span> className=<span class="string">"opacity-50 pointer-events-none"</span><span class="keyword">&gt;</span>
                {children}
            <span class="keyword">&lt;/div&gt;</span>

            {showLock && (
                <span class="keyword">&lt;div</span> className=<span class="string">"absolute inset-0 flex items-center justify-center bg-black/20 rounded"</span><span class="keyword">&gt;</span>
                    <span class="keyword">&lt;Lock</span> className=<span class="string">"w-5 h-5 text-purple-500"</span> <span class="keyword">/&gt;</span>
                <span class="keyword">&lt;/div&gt;</span>
            )}

            {showUpgrade && (
                <span class="keyword">&lt;UpgradeModal</span> onClose={() => <span class="function">setShowUpgrade</span>(<span class="keyword">false</span>)} <span class="keyword">/&gt;</span>
            )}
        <span class="keyword">&lt;/div&gt;</span>
    );
}

<span class="comment">// Simple upgrade modal</span>
<span class="keyword">function</span> <span class="function">UpgradeModal</span>({ onClose }: { onClose: () => <span class="keyword">void</span> }) {
    <span class="keyword">const</span> { checkout } = <span class="function">useSubscriptionContext</span>();

    <span class="keyword">return</span> (
        <span class="keyword">&lt;div</span> className=<span class="string">"fixed inset-0 bg-black/50 flex items-center justify-center z-50"</span><span class="keyword">&gt;</span>
            <span class="keyword">&lt;div</span> className=<span class="string">"bg-white dark:bg-gray-900 rounded-2xl p-8 max-w-md"</span><span class="keyword">&gt;</span>
                <span class="keyword">&lt;h2</span> className=<span class="string">"text-2xl font-bold mb-4"</span><span class="keyword">&gt;</span>Upgrade to Pro<span class="keyword">&lt;/h2&gt;</span>
                <span class="keyword">&lt;p</span> className=<span class="string">"text-gray-600 mb-6"</span><span class="keyword">&gt;</span>
                    Unlock this feature and 40+ more with SnapBeautify Pro.
                <span class="keyword">&lt;/p&gt;</span>
                <span class="keyword">&lt;div</span> className=<span class="string">"flex gap-4"</span><span class="keyword">&gt;</span>
                    <span class="keyword">&lt;button</span>
                        onClick={onClose}
                        className=<span class="string">"flex-1 py-2 border rounded-lg"</span>
                    <span class="keyword">&gt;</span>
                        Maybe Later
                    <span class="keyword">&lt;/button&gt;</span>
                    <span class="keyword">&lt;button</span>
                        onClick={() => <span class="function">checkout</span>(
                            process.env.<span class="variable">NEXT_PUBLIC_STRIPE_PRICE_MONTHLY</span>!,
                            <span class="string">'pro_monthly'</span>
                        )}
                        className=<span class="string">"flex-1 py-2 bg-purple-600 text-white rounded-lg"</span>
                    <span class="keyword">&gt;</span>
                        Upgrade - $9/mo
                    <span class="keyword">&lt;/button&gt;</span>
                <span class="keyword">&lt;/div&gt;</span>
            <span class="keyword">&lt;/div&gt;</span>
        <span class="keyword">&lt;/div&gt;</span>
    );
}</code></pre>

            <h3>Usage in Components</h3>
            <pre><code><span class="comment">// Example: Gating a premium background type</span>
<span class="keyword">&lt;FeatureGate</span> feature=<span class="string">"wave_split"</span><span class="keyword">&gt;</span>
    <span class="keyword">&lt;Button</span> onClick={() => <span class="function">setBackgroundType</span>(<span class="string">'waveSplit'</span>)}<span class="keyword">&gt;</span>
        Wave Split
    <span class="keyword">&lt;/Button&gt;</span>
<span class="keyword">&lt;/FeatureGate&gt;</span>

<span class="comment">// Example: Limiting text overlays for free users</span>
<span class="keyword">const</span> canAddOverlay = isPro || textOverlays.length < <span class="number">1</span>;

{canAddOverlay ? (
    <span class="keyword">&lt;Button</span> onClick={addTextOverlay}<span class="keyword">&gt;</span>Add Text<span class="keyword">&lt;/Button&gt;</span>
) : (
    <span class="keyword">&lt;FeatureGate</span> feature=<span class="string">"unlimited_text_overlays"</span><span class="keyword">&gt;</span>
        <span class="keyword">&lt;Button&gt;</span>Add Text (Pro)<span class="keyword">&lt;/Button&gt;</span>
    <span class="keyword">&lt;/FeatureGate&gt;</span>
)}

<span class="comment">// Example: Gating export resolution</span>
<span class="keyword">&lt;select</span> value={exportScale}<span class="keyword">&gt;</span>
    <span class="keyword">&lt;option</span> value=<span class="string">"1"</span><span class="keyword">&gt;</span>1x<span class="keyword">&lt;/option&gt;</span>
    <span class="keyword">&lt;option</span> value=<span class="string">"2"</span><span class="keyword">&gt;</span>2x<span class="keyword">&lt;/option&gt;</span>
    <span class="keyword">&lt;option</span> value=<span class="string">"3"</span> disabled={!isPro}<span class="keyword">&gt;</span>3x {!isPro && <span class="string">'üîí'</span>}<span class="keyword">&lt;/option&gt;</span>
    <span class="keyword">&lt;option</span> value=<span class="string">"4"</span> disabled={!isPro}<span class="keyword">&gt;</span>4x {!isPro && <span class="string">'üîí'</span>}<span class="keyword">&lt;/option&gt;</span>
<span class="keyword">&lt;/select&gt;</span></code></pre>
        </section>

        <!-- Section 11: Testing -->
        <section id="testing" class="section">
            <div class="section-header">
                <div class="section-number">11</div>
                <h2 class="section-title">Testing</h2>
            </div>

            <h3>Stripe Test Mode</h3>
            <p>Use test API keys (start with <code>pk_test_</code> and <code>sk_test_</code>).</p>

            <h3>Test Card Numbers</h3>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Card Number</th>
                            <th>Result</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>4242 4242 4242 4242</code></td>
                            <td>Successful payment</td>
                        </tr>
                        <tr>
                            <td><code>4000 0000 0000 9995</code></td>
                            <td>Insufficient funds</td>
                        </tr>
                        <tr>
                            <td><code>4000 0000 0000 0002</code></td>
                            <td>Declined</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>Local Webhook Testing</h3>
            <pre><code><span class="comment"># Install Stripe CLI</span>
brew install stripe/stripe-cli/stripe

<span class="comment"># Login to Stripe</span>
stripe login

<span class="comment"># Forward webhooks to local server</span>
stripe listen --forward-to localhost:3000/api/stripe/webhook

<span class="comment"># Copy the webhook signing secret and add to .env.local</span></code></pre>

            <div class="alert alert-success">
                <span class="alert-icon">‚úÖ</span>
                <div>
                    <strong>Testing Checklist:</strong>
                    <ul style="margin-top: 8px; margin-left: 16px;">
                        <li>User can sign up and is created in database</li>
                        <li>Free user sees locked features</li>
                        <li>Checkout redirects to Stripe</li>
                        <li>Payment completes successfully</li>
                        <li>Webhook updates subscription in database</li>
                        <li>User now sees Pro features unlocked</li>
                        <li>Customer portal works for managing subscription</li>
                        <li>Cancellation updates status correctly</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Section 12: Deployment -->
        <section id="deployment" class="section">
            <div class="section-header">
                <div class="section-number">12</div>
                <h2 class="section-title">Deployment to Vercel</h2>
            </div>

            <h3>Step 1: Push to GitHub</h3>
            <pre><code>git add .
git commit -m <span class="string">"Add subscription system"</span>
git push origin main</code></pre>

            <h3>Step 2: Deploy to Vercel</h3>
            <div class="step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <h4>Import Project</h4>
                    <p>Go to vercel.com ‚Üí New Project ‚Üí Import from GitHub</p>
                </div>
            </div>
            <div class="step">
                <div class="step-number">2</div>
                <div class="step-content">
                    <h4>Add Environment Variables</h4>
                    <p>Add all variables from .env.local to Vercel project settings</p>
                </div>
            </div>
            <div class="step">
                <div class="step-number">3</div>
                <div class="step-content">
                    <h4>Deploy</h4>
                    <p>Click Deploy and wait for build to complete</p>
                </div>
            </div>

            <h3>Step 3: Configure Production Stripe</h3>
            <div class="step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <h4>Switch to Live Mode</h4>
                    <p>In Stripe Dashboard, toggle to Live mode and get live API keys</p>
                </div>
            </div>
            <div class="step">
                <div class="step-number">2</div>
                <div class="step-content">
                    <h4>Create Live Products</h4>
                    <p>Recreate your products/prices in Live mode</p>
                </div>
            </div>
            <div class="step">
                <div class="step-number">3</div>
                <div class="step-content">
                    <h4>Add Production Webhook</h4>
                    <p>Create webhook endpoint with your production URL: <code>https://your-app.vercel.app/api/stripe/webhook</code></p>
                </div>
            </div>
            <div class="step">
                <div class="step-number">4</div>
                <div class="step-content">
                    <h4>Update Environment Variables</h4>
                    <p>Update Vercel env vars with live Stripe keys and webhook secret</p>
                </div>
            </div>

            <div class="alert alert-warning">
                <span class="alert-icon">‚ö†Ô∏è</span>
                <div>
                    <strong>Before Going Live:</strong>
                    <ul style="margin-top: 8px; margin-left: 16px;">
                        <li>Test the entire flow in production with test mode first</li>
                        <li>Set up Stripe Tax if needed for your region</li>
                        <li>Configure email notifications in Stripe</li>
                        <li>Set up Customer Portal branding</li>
                        <li>Add Terms of Service and Privacy Policy links</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Final Checklist -->
        <section class="section">
            <div class="section-header">
                <div class="section-number">‚úì</div>
                <h2 class="section-title">Final Implementation Checklist</h2>
            </div>

            <ul class="checklist">
                <li>Supabase project created with database tables</li>
                <li>Row Level Security policies configured</li>
                <li>Stripe account created with products/prices</li>
                <li>Environment variables configured locally and on Vercel</li>
                <li>Authentication flow working (signup, login, logout)</li>
                <li>Checkout session creation working</li>
                <li>Webhook handler receiving and processing events</li>
                <li>Customer portal working for subscription management</li>
                <li>Feature gating implemented in frontend</li>
                <li>Pricing page displaying plans correctly</li>
                <li>Tested with Stripe test cards</li>
                <li>Production webhook configured</li>
                <li>Live Stripe keys added to production</li>
                <li>SSL certificate active (automatic on Vercel)</li>
            </ul>
        </section>

        <!-- Resources -->
        <section class="section">
            <div class="section-header">
                <div class="section-number">üìö</div>
                <h2 class="section-title">Resources & Documentation</h2>
            </div>

            <div class="card-grid">
                <div class="card">
                    <div class="card-title">Stripe Docs</div>
                    <p style="margin:0; color: var(--gray); font-size: 0.875rem;">
                        <a href="https://stripe.com/docs" target="_blank" style="color: var(--primary);">stripe.com/docs</a><br>
                        Checkout, Webhooks, Customer Portal
                    </p>
                </div>
                <div class="card">
                    <div class="card-title">Supabase Docs</div>
                    <p style="margin:0; color: var(--gray); font-size: 0.875rem;">
                        <a href="https://supabase.com/docs" target="_blank" style="color: var(--primary);">supabase.com/docs</a><br>
                        Auth, Database, Row Level Security
                    </p>
                </div>
                <div class="card">
                    <div class="card-title">Vercel Docs</div>
                    <p style="margin:0; color: var(--gray); font-size: 0.875rem;">
                        <a href="https://vercel.com/docs" target="_blank" style="color: var(--primary);">vercel.com/docs</a><br>
                        Serverless Functions, Environment Variables
                    </p>
                </div>
                <div class="card">
                    <div class="card-title">Next.js Docs</div>
                    <p style="margin:0; color: var(--gray); font-size: 0.875rem;">
                        <a href="https://nextjs.org/docs" target="_blank" style="color: var(--primary);">nextjs.org/docs</a><br>
                        App Router, API Routes
                    </p>
                </div>
            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>SnapBeautify Implementation Guide ‚Ä¢ January 2026</p>
        <p style="margin-top: 8px; opacity: 0.7;">Complete guide for implementing paid subscriptions with Vercel Serverless + Stripe + Supabase</p>
    </footer>
</body>
</html>
